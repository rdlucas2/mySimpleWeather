<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Sample Weather App</title>
		<meta name="description" content="">
		<meta name="author" content="">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
		<style type="text/css">
			.roundedWithBackground {
				border-radius: 10px;
				background: rgba(0,0,0,0.5);
				color:white;
			}
			.innerContainer {
				border-radius: 10px;
				background: rgba(255,255,255,0.5);
				padding:15px;
			}
			.headerPadding {
				padding:10px;
			}
		</style>
	</head>
	<body>
		<!-- Static navbar -->
		<nav class="navbar navbar-default navbar-static-top">
			<div class="container">
				<div class="navbar-header">
					<a class="navbar-brand" href="#">Weather Time</a>
				</div>
				<div class="navbar-form navbar-right" role="location">
					<form class="form-group" id="locationForm">
						<div class="input-group">
							<input type="text" id="location" class="form-control" placeholder="location">
							<span class="input-group-btn">
								<button class="btn btn-default" type="submit">Go!</button>
							</span>
						</div><!-- /input-group -->					
					</div>
				</form>
			</div>
		</nav>		
	
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
					<div class="innerContainer">

						<div class="row">
							<div class="col-sm-12">
								<div class="roundedWithBackground">
									<h4 class="title text-center headerPadding"></h1>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-sm-8 col-sm-offset-2">
								<p class="day0 text-center roundedWithBackground"></p>		
							</div>
						</div>

						<div class="row">
							<div class="col-sm-6">
								<p class="day1 text-center roundedWithBackground"></p>		
							</div>
							<div class="col-sm-6">
								<p class="day2 text-center roundedWithBackground"></p>		
							</div>
						</div>

						<div class="row">
							<div class="col-sm-6">
								<p class="day3 text-center roundedWithBackground"></p>		
							</div>
							<div class="col-sm-6">
								<p class="day4 text-center roundedWithBackground"></p>		
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				var yahooBaseYqlUrl = 'https://query.yahooapis.com/v1/public/yql?q=';
				
				function FlickrImages(yahooBaseYqlUrl) {
					this.apiKey = '429cce0f83cf8b43f51a97d4d26360bb';
					this.yahooBaseYqlUrl = yahooBaseYqlUrl;
				}
				
				FlickrImages.prototype.generateQueryTagString = function(text) {
					var textArray = text.split(' ');
					var tags = '';
					for(var i = 0; i < textArray.length; i++) {
						tags += textArray[i] 
						if(i !== textArray.length-1) {
							tags += '%2C%20';
						}
					}
					return tags;
				};
				
				FlickrImages.prototype.getBackgroundImagesWithText = function(text) {
					var formattedText = text.replace(/ /g,"%20");
					var getBackgroundQuery= "select%20source%20from%20flickr.photos.sizes%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20photo_id%20in%20(select%20id%20from%20flickr.photos.search%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20text%3D%22" + formattedText + "%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getBackgroundUrl = this.yahooBaseYqlUrl + getBackgroundQuery;
					return $.get(getBackgroundUrl);
				};
				
				FlickrImages.prototype.getBackgroundImagesWithTags = function(text) {
					var tags = this.generateQueryTagString(text);
					var getBackgroundQuery= "select%20source%20from%20flickr.photos.sizes%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20photo_id%20in%20(select%20id%20from%20flickr.photos.search%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20tags%3D%22" + tags + "%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getBackgroundUrl = this.yahooBaseYqlUrl + getBackgroundQuery;
					return $.get(getBackgroundUrl);
				};
				
				FlickrImages.prototype.getBackgroundImagesWithTextAndTags = function(text) {
					var formattedText = text.replace(/ /g,"%20");
					var tags = this.generateQueryTagString(text);
					var getBackgroundQuery= "select%20source%20from%20flickr.photos.sizes%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20photo_id%20in%20(select%20id%20from%20flickr.photos.search%20where%20api_key%3D%22" + this.apiKey + "%22%20and%20text%3D%22" + formattedText + "%22%20and%20tags%3D%22" + tags + "%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getBackgroundUrl = this.yahooBaseYqlUrl + getBackgroundQuery;
					return $.get(getBackgroundUrl);
				};				
			
				function YahooWeather(yahooBaseYqlUrl) {
					this.yahooBaseYqlUrl = yahooBaseYqlUrl;
				}

				YahooWeather.prototype.getWeather = function(location) {
					var getWeatherQuery = "select%20*%20from%20weather.forecast%20where%20location%20in%20(%20select%20uzip%20from%20geo.placefinder%20where%20text%3D%22" + location + "%22%20)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getWeatherUrl = this.yahooBaseYqlUrl + getWeatherQuery;
					return $.get(getWeatherUrl);
				};
				
				YahooWeather.prototype.getWeatherByWoeId = function(woeid) {
					var getWeatherQuery = "select%20*%20from%20weather.woeid%20where%20w%3D%22" + woeid + "%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getWeatherUrl = this.yahooBaseYqlUrl + getWeatherQuery;
					return $.get(getWeatherUrl);
				};
				
				function YahooGeo(yahooBaseYqlUrl) {
					this.yahooBaseYqlUrl = yahooBaseYqlUrl;
				}
				
				YahooGeo.prototype.getWoeIdFromLocation = function(location) {
					var formattedLocation = location.replace(/ /g,"%20");
					var getGeoWoeIdQuery = "select%20*%20from%20geo.places%20where%20text%3D%22" + formattedLocation + "%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=";
					var getGeoWoeIdUrl = this.yahooBaseYqlUrl + getGeoWoeIdQuery;
					return $.get(getGeoWoeIdUrl);
				};
				
				function App(flickrImages, yahooWeather, yahooGeo) {
					this.flickrImages = flickrImages;
					this.yahooWeather = yahooWeather;
					this.yahooGeo = yahooGeo;
				}
				
				App.prototype.getRandomNumberBetween = function(lowerBound, upperBound) {
					return Math.floor(Math.random() * ((upperBound-lowerBound)+1) + lowerBound);
				};
				
				App.prototype.displayWeather = function(weather) {
					$('.title').html(weather.title);
					for(var i = 0; i < weather.forecast.length; i++) {
						$('.day' + i).html(
							weather.forecast[i].day + 
							' ' + 
							weather.forecast[i].date + 
							'<br>High:' + 
							weather.forecast[i].high + 
							'&#176; <br>Low:' + 
							weather.forecast[i].low + 
							'&#176; <br>' + 
							weather.forecast[i].text
						);
					}
				};
				
				App.prototype.setFullWidthBackground = function(imageUrl) {
					$('body').css('background-image', 'url(' + imageUrl + ')');
					$('body').css('background-repeat', 'no-repeat');
					$('body').css('background-position', 'center center fixed');
					$('body').css('-webkit-background-size', 'cover');
					$('body').css('-moz-background-size', 'cover');
					$('body').css('-o-background-size', 'cover');
					$('body').css('background-size', 'cover');
				};
				
				App.prototype.refreshWeatherByWoeId = function(location) {
					var self = this;
					$.when(self.yahooGeo.getWoeIdFromLocation(location))
						.then(function(data) {
							var place = data.query.results.place;
							var woeid = '';
							if( Object.prototype.toString.call(place) === '[object Array]' ) {
								woeid = place[0].woeid;							
							} else {
								woeid = place.woeid;	
							}
							$.when(self.yahooWeather.getWeatherByWoeId(woeid))
								.then(function(data) {
									var weather = data.query.results.rss.channel.item;
									self.displayWeather(weather);
									$.when(self.flickrImages.getBackgroundImagesWithTextAndTags(weather.forecast[0].text))
										.then(function(data) {
											var imageUrls = $.grep(data.query.results.size, function(item) {
												var lastSix = item.source.slice(-6);
												return lastSix.indexOf('_') === -1;
											});
											var upperBound = imageUrls.length-1;
											var randomInRange = self.getRandomNumberBetween(0, upperBound);
											var imageUrl = imageUrls[randomInRange].source;
											self.setFullWidthBackground(imageUrl);
										});
								});
						});
				};
				
				App.prototype.refreshWeather = function(location) {
					var self = this;
					$.when(self.yahooWeather.getWeather(location))
						.then(function(data) {
							var weather = data.query.results.channel.item;
							self.displayWeather(weather);
							$.when(self.flickrImages.getBackgroundImagesWithTextAndTags(weather.forecast[0].text))
								.then(function(data) {
									var imageUrls = $.grep(data.query.results.size, function(item) {
										var lastSix = item.source.slice(-6);
										return lastSix.indexOf('_') === -1;
									});
									var upperBound = imageUrls.length-1;
									var randomInRange = self.getRandomNumberBetween(0, upperBound);
									var imageUrl = imageUrls[randomInRange].source;
									self.setFullWidthBackground(imageUrl);
								});
						});
				};
				
				App.prototype.init = function() {
					//this.refreshWeather('15001');
					this.refreshWeatherByWoeId('Aliquippa PA');
				};
				
				var flickrImages = new FlickrImages(yahooBaseYqlUrl);
				var yahooWeather = new YahooWeather(yahooBaseYqlUrl);
				var yahooGeo = new YahooGeo(yahooBaseYqlUrl);
				var app = new App(flickrImages, yahooWeather, yahooGeo);
				app.init();
				
				/*
				$('#locationForm').submit(function(e) {
					e.preventDefault();
					var location = $('#location').val();
					if(location) {
						app.refreshWeather(location);
					}
				});
				*/
				
				$('#locationForm').submit(function(e) {
					e.preventDefault();
					var location = $('#location').val();
					if(location) {
						app.refreshWeatherByWoeId(location);
					}
				});

			});
		</script>
	</body>
</html>